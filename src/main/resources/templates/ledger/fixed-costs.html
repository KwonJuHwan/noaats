<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê³ ì • ì§€ì¶œ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
  <a href="/" class="btn btn-link">&larr; ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  <h2 class="mb-4">ğŸ  ê³ ì • ì§€ì¶œ ê´€ë¦¬</h2>

  <div class="card mb-4 border-primary">
    <div class="card-body">
      <h5 id="fixedFormTitle">ìƒˆ ê³ ì • ì§€ì¶œ ë“±ë¡</h5>
      <form id="fixedForm" th:action="@{/fixed-costs/register}" method="post"
            class="row g-2 align-items-end" onsubmit="return validateFixedCost()">

        <div class="col-md-3">
          <label class="form-label small text-muted">í•­ëª©ëª…</label>
          <input type="text" name="title" id="fixedTitle" class="form-control" placeholder="ì˜ˆ: ì›”ì„¸" required>
        </div>

        <div class="col-md-3">
          <label class="form-label small text-muted">ê¸ˆì•¡</label>
          <input type="number" name="amount" id="fixedAmount" class="form-control" placeholder="ê¸ˆì•¡" required>
        </div>

        <div class="col-md-2">
          <label class="form-label small text-muted">ê²°ì œì¼</label>
          <input type="number" name="paymentDay" id="fixedDay" class="form-control" placeholder="1~31" required>
        </div>

        <div class="col-md-3">
          <label class="form-label small text-muted">ì¹´í…Œê³ ë¦¬</label>
          <div class="d-flex gap-1">
            <select id="parentCategory" class="form-select" onchange="loadChildCategories(this.value)" required>
              <option value="">ëŒ€ë¶„ë¥˜</option>
              <option th:each="cat : ${rootCategories}"
                      th:value="${cat.id}"
                      th:text="${cat.name}">
              </option>
            </select>

            <select name="categoryId" id="childCategory" class="form-select" style="display:none;">
              <option value="">ì†Œë¶„ë¥˜</option>
            </select>
          </div>
        </div>

        <div class="col-md-1">
          <button type="submit" class="btn btn-primary w-100" id="fixedSubmitBtn">ë“±ë¡</button>
          <button type="button" class="btn btn-sm btn-link w-100 mt-1" onclick="resetFixedForm()" id="fixedCancelBtn" style="display:none; font-size: 0.8rem;">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <table class="table table-hover bg-white shadow-sm">
    <thead class="table-dark">
    <tr>
      <th>í•­ëª©</th>
      <th>ê¸ˆì•¡</th>
      <th>ê²°ì œì¼</th>
      <th>ì¹´í…Œê³ ë¦¬</th>
      <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="fc : ${fixedCosts}">
      <td th:text="${fc.title}">ì›”ì„¸</td>
      <td th:text="${#numbers.formatInteger(fc.amount, 0, 'COMMA')} + 'ì›'">500,000</td>
      <td th:text="${fc.paymentDay} + 'ì¼'">25</td>
      <td th:text="${fc.categoryName}">ì£¼ê±°ë¹„ > ì›”ì„¸</td> <td>
      <button type="button" class="btn btn-sm btn-warning"
              th:data-id="${fc.fixedCostId}"
              th:data-title="${fc.title}"
              th:data-amount="${fc.amount}"
              th:data-day="${fc.paymentDay}"
              th:data-parent-id="${fc.parentId}"
              th:data-child-id="${fc.categoryId}"
              onclick="fillFixedForm(this)">ìˆ˜ì •</button>

      <form th:action="@{/fixed-costs/delete/{id}(id=${fc.fixedCostId})}" method="post" style="display:inline;">
        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ì‚­ì œí• ê¹Œìš”?')">ì‚­ì œ</button>
      </form>
    </td>
    </tr>
    </tbody>
  </table>
</div>

<script>
  // 1. ì¹´í…Œê³ ë¦¬ ë¡œë”© (ê³µí†µ ë¡œì§)
  async function loadChildCategories(parentId, selectedChildId = null) {
    const childSelect = document.getElementById('childCategory');
    const parentSelect = document.getElementById('parentCategory');

    if (!parentId) {
      childSelect.style.display = 'none';
      childSelect.innerHTML = '<option value="">ì†Œë¶„ë¥˜</option>';
      childSelect.removeAttribute('name');
      parentSelect.removeAttribute('name');
      return;
    }

    try {
      const response = await fetch(`/api/categories/${parentId}`);
      if (!response.ok) throw new Error("ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨");

      const children = await response.json();

      if (children.length > 0) {
        let options = '<option value="">ì†Œë¶„ë¥˜</option>';
        children.forEach(cat => {
          const isSelected = (selectedChildId && String(cat.id) === String(selectedChildId)) ? 'selected' : '';
          options += `<option value="${cat.id}" ${isSelected}>${cat.name}</option>`;
        });

        childSelect.innerHTML = options;
        childSelect.style.display = 'block';
        childSelect.required = true;
        childSelect.setAttribute('name', 'categoryId');
        parentSelect.removeAttribute('name');
      } else {
        // ì†Œë¶„ë¥˜ ì—†ìŒ -> ëŒ€ë¶„ë¥˜ê°€ ê³§ ê°’
        childSelect.style.display = 'none';
        childSelect.required = false;
        childSelect.removeAttribute('name');
        parentSelect.setAttribute('name', 'categoryId');
      }
    } catch (error) {
      console.error(error);
      alert('ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // 2. ìˆ˜ì • í¼ ì±„ìš°ê¸° (Async í•„ìˆ˜)
  async function fillFixedForm(btn) {
    const id = btn.dataset.id;
    const title = btn.dataset.title;
    const amount = btn.dataset.amount;
    const day = btn.dataset.day;

    // ë°ì´í„°ì…‹ì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ì¶œ
    const parentId = btn.dataset.parentId;
    const childId = btn.dataset.childId;

    document.getElementById('fixedFormTitle').innerText = "ê³ ì • ì§€ì¶œ ìˆ˜ì •";
    document.getElementById('fixedTitle').value = title;
    document.getElementById('fixedAmount').value = amount;
    document.getElementById('fixedDay').value = day;

    // ì¹´í…Œê³ ë¦¬ ì„¸íŒ… ë¡œì§
    if (parentId) {
      document.getElementById('parentCategory').value = parentId;
      await loadChildCategories(parentId, childId);
    } else {
      document.getElementById('parentCategory').value = childId; // í˜¹ì€ ë£¨íŠ¸ ì¹´í…Œê³ ë¦¬ì¼ ê²½ìš°
      await loadChildCategories(childId);
    }

    document.getElementById('fixedSubmitBtn').innerText = "ìˆ˜ì •";
    document.getElementById('fixedSubmitBtn').className = "btn btn-warning w-100";
    document.getElementById('fixedCancelBtn').style.display = "block";

    document.getElementById('fixedForm').action = "/fixed-costs/update/" + id;
  }

  // 3. í¼ ë¦¬ì…‹
  function resetFixedForm() {
    document.getElementById('fixedFormTitle').innerText = "ìƒˆ ê³ ì • ì§€ì¶œ ë“±ë¡";
    document.getElementById('fixedTitle').value = "";
    document.getElementById('fixedAmount').value = "";
    document.getElementById('fixedDay').value = "";

    // ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™”
    document.getElementById('parentCategory').value = "";
    document.getElementById('childCategory').style.display = 'none';
    document.getElementById('childCategory').innerHTML = '<option value="">ì†Œë¶„ë¥˜</option>';

    document.getElementById('fixedSubmitBtn').innerText = "ë“±ë¡";
    document.getElementById('fixedSubmitBtn').className = "btn btn-primary w-100";
    document.getElementById('fixedCancelBtn').style.display = "none";

    document.getElementById('fixedForm').action = "/fixed-costs/register";
  }

  function validateFixedCost() {
    const amountInput = document.getElementById('fixedAmount');
    const amount = Number(amountInput.value);

    const dayInput = document.getElementById('fixedDay');
    const day = Number(dayInput.value);

    // ê¸ˆì•¡ ê²€ì¦
    if (amount <= 0) {
      alert("ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      amountInput.focus();
      return false;
    }

    // ë‚ ì§œ ê²€ì¦
    if (day < 1 || day > 31) {
      alert("ê²°ì œì¼ì€ 1ì¼ì—ì„œ 31ì¼ ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
      dayInput.focus();
      return false;
    }

    return true;
  }

</script>
</body>
</html>