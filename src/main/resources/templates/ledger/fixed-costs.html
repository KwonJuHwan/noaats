<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/fragments :: head('ê³ ì • ì§€ì¶œ ê´€ë¦¬', ~{})}"></head>
<body class="bg-light">

<div class="container mt-5">
  <a href="/" class="btn btn-link">&larr; ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  <h2 class="mb-4">ğŸ  ê³ ì • ì§€ì¶œ ê´€ë¦¬</h2>

  <div class="card mb-4 border-primary">
    <div class="card-body">
      <h5 id="fixedFormTitle">ìƒˆ ê³ ì • ì§€ì¶œ ë“±ë¡</h5>
      <form id="fixedForm" class="row g-2 align-items-end">
        <div class="col-md-3"><label class="form-label small text-muted">í•­ëª©ëª…</label><input type="text" name="title" id="fixedTitle" class="form-control" placeholder="ì˜ˆ: ì›”ì„¸" required></div>
        <div class="col-md-3"><label class="form-label small text-muted">ê¸ˆì•¡</label><input type="number" name="amount" id="fixedAmount" class="form-control" placeholder="ê¸ˆì•¡" required></div>
        <div class="col-md-2"><label class="form-label small text-muted">ê²°ì œì¼</label><input type="number" name="paymentDay" id="fixedDay" class="form-control" placeholder="1~31" required></div>
        <div class="col-md-3">
          <label class="form-label small text-muted">ì¹´í…Œê³ ë¦¬</label>
          <div class="d-flex gap-1">
            <select id="parentCategory" class="form-select" onchange="loadChildCategories(this.value)" required>
              <option value="">ëŒ€ë¶„ë¥˜</option>
              <option th:each="cat : ${rootCategories}" th:value="${cat.id}" th:text="${cat.name}"></option>
            </select>
            <select name="categoryId" id="childCategory" class="form-select" style="display:none;">
              <option value="">ì†Œë¶„ë¥˜</option>
            </select>
          </div>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-primary w-100" id="fixedSubmitBtn" onclick="saveFixedCost()">ë“±ë¡</button>
          <button type="button" class="btn btn-sm btn-link w-100 mt-1" onclick="resetFixedForm()" id="fixedCancelBtn" style="display:none; font-size: 0.8rem;">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <table class="table table-hover bg-white shadow-sm">
    <thead class="table-dark"><tr><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ê²°ì œì¼</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê´€ë¦¬</th></tr></thead>
    <tbody>
    <tr th:each="fc : ${fixedCosts}">
      <td th:text="${fc.title}"></td>
      <td th:text="${#numbers.formatInteger(fc.amount, 0, 'COMMA')} + 'ì›'"></td>
      <td th:text="${fc.paymentDay} + 'ì¼'"></td>
      <td th:text="${fc.categoryName}"></td>
      <td>
        <button type="button" class="btn btn-sm btn-warning" th:data-id="${fc.fixedCostId}" th:data-title="${fc.title}" th:data-amount="${fc.amount}" th:data-day="${fc.paymentDay}" th:data-parent-id="${fc.parentId}" th:data-child-id="${fc.categoryId}" onclick="fillFixedForm(this)">ìˆ˜ì •</button>
        <button type="button" class="btn btn-sm btn-danger" th:onclick="|deleteFixedCost(${fc.fixedCostId})|">ì‚­ì œ</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div th:replace="~{layout/fragments :: errorModal}"></div>
<th:block th:replace="~{layout/fragments :: scripts}"></th:block>

<script>
  async function saveFixedCost() {
    if (!validateFixedCost()) return;
    const id = document.getElementById('fixedForm').dataset.id;
    const parentSelect = document.getElementById('parentCategory');
    const childSelect = document.getElementById('childCategory');

    let categoryId = parentSelect.value;
    if (childSelect.style.display !== 'none' && childSelect.value) categoryId = childSelect.value;
    if(!categoryId) { alert("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

    const data = {
      title: document.getElementById('fixedTitle').value,
      amount: Number(document.getElementById('fixedAmount').value),
      paymentDay: Number(document.getElementById('fixedDay').value),
      categoryId: Number(categoryId)
    };

    try {
      let url = '/api/fixed-costs';
      let method = 'POST';
      if (id) { url += '/' + id; method = 'PUT'; }

      await callApi(url, method, data);
      alert(id ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } catch (e) { console.log(e); }
  }

  async function deleteFixedCost(id) {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      await callApi(`/api/fixed-costs/${id}`, 'DELETE');
      location.reload();
    } catch(e) { console.log(e); }
  }

  async function loadChildCategories(parentId, selectedChildId = null) {
    const childSelect = document.getElementById('childCategory');
    if (!parentId) {
      childSelect.style.display = 'none';
      childSelect.innerHTML = '<option value="">ì†Œë¶„ë¥˜</option>';
      return;
    }
    try {
      const children = await callApi(`/api/categories/${parentId}`);
      if (children.length > 0) {
        let options = '<option value="">ì†Œë¶„ë¥˜</option>';
        children.forEach(cat => {
          const isSelected = (selectedChildId && String(cat.id) === String(selectedChildId)) ? 'selected' : '';
          options += `<option value="${cat.id}" ${isSelected}>${cat.name}</option>`;
        });
        childSelect.innerHTML = options;
        childSelect.style.display = 'block';
        childSelect.required = true;
      } else {
        childSelect.style.display = 'none';
        childSelect.required = false;
      }
    } catch (error) { console.error(error); }
  }

  async function fillFixedForm(btn) {
    document.getElementById('fixedFormTitle').innerText = "ê³ ì • ì§€ì¶œ ìˆ˜ì •";
    document.getElementById('fixedTitle').value = btn.dataset.title;
    document.getElementById('fixedAmount').value = btn.dataset.amount;
    document.getElementById('fixedDay').value = btn.dataset.day;

    const parentId = btn.dataset.parentId;
    const childId = btn.dataset.childId;
    document.getElementById('parentCategory').value = parentId ? parentId : childId;

    if (parentId) await loadChildCategories(parentId, childId);
    else await loadChildCategories(childId);

    document.getElementById('fixedSubmitBtn').innerText = "ìˆ˜ì •";
    document.getElementById('fixedSubmitBtn').className = "btn btn-warning w-100";
    document.getElementById('fixedCancelBtn').style.display = "block";
    document.getElementById('fixedForm').dataset.id = btn.dataset.id;
  }

  function resetFixedForm() {
    document.getElementById('fixedFormTitle').innerText = "ìƒˆ ê³ ì • ì§€ì¶œ ë“±ë¡";
    document.getElementById('fixedTitle').value = "";
    document.getElementById('fixedAmount').value = "";
    document.getElementById('fixedDay').value = "";
    document.getElementById('parentCategory').value = "";
    document.getElementById('childCategory').style.display = 'none';
    document.getElementById('childCategory').innerHTML = '<option value="">ì†Œë¶„ë¥˜</option>';
    document.getElementById('fixedSubmitBtn').innerText = "ë“±ë¡";
    document.getElementById('fixedSubmitBtn').className = "btn btn-primary w-100";
    document.getElementById('fixedCancelBtn').style.display = "none";
    delete document.getElementById('fixedForm').dataset.id;
  }

  function validateFixedCost() {
    if (Number(document.getElementById('fixedAmount').value) <= 0) { alert("ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return false; }
    const day = Number(document.getElementById('fixedDay').value);
    if (day < 1 || day > 31) { alert("ê²°ì œì¼ì€ 1ì¼ì—ì„œ 31ì¼ ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤."); return false; }
    return true;
  }
</script>
</body>
</html>