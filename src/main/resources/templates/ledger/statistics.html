<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>월간 지출 통계 - SaveME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .stat-card {
      transition: 0.3s;
    }
    .stat-card:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-4">
  <div class="container">
    <a th:href="@{/}" class="navbar-brand mb-0 h1">SaveME DashBoard</a>
  </div>
</nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a th:href="@{/statistics(yearMonth=${view.prevMonth})}" class="btn btn-outline-secondary">&lt; 이전달</a>
    <h3 class="fw-bold" th:text="${view.currentMonth} + ' 지출 통계'">2026-02 지출 통계</h3>
    <a th:href="@{/statistics(yearMonth=${view.nextMonth})}" class="btn btn-outline-secondary">다음달 &gt;</a>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-4">카테고리별 비중</h5>

          <div class="chart-container" th:if="${view.hasData}">
            <canvas id="expenseChart"></canvas>
          </div>

          <div th:if="${!view.hasData}" class="text-center mt-5 text-muted">
            <p class="mb-0">해당 월의 지출 내역이 없습니다.</p>
            <small>지출을 기록하면 통계가 생성됩니다.</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">상세 내역</h5>

          <div class="list-group list-group-flush" th:if="${view.hasData}">
            <div th:each="stat : ${view.stats}" class="list-group-item stat-card d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-bold" th:text="${stat.categoryName}">식비</span>
                <small class="text-muted ms-2" th:text="'(' + ${stat.percentage} + '%)'"> (45.5%)</small>
              </div>
              <span class="text-primary fw-bold" th:text="${#numbers.formatInteger(stat.totalAmount, 0, 'COMMA')} + '원'">350,000원</span>
            </div>
          </div>

          <div th:if="${!view.hasData}" class="text-center py-5 text-muted">
            데이터 없음
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /* [핵심 수정] 타임리프 view 객체에서 stats 추출 */
  const statsData = [[${view.stats}]];

  // 데이터가 존재할 때만 차트 생성 로직 수행
  if (statsData && statsData.length > 0) {
    const ctx = document.getElementById('expenseChart').getContext('2d');

    // 데이터 매핑
    const labels = statsData.map(s => s.categoryName);
    const data = statsData.map(s => s.totalAmount);
    const percentages = statsData.map(s => s.percentage);

    // Chart.js 인스턴스 생성
    new Chart(ctx, {
      type: 'pie', // 도넛 차트로 변경 원하면 'doughnut'
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#8AC926', '#1982C4'
          ],
          hoverOffset: 10 // 호버 시 섹션 확대 효과
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom', // 범례 위치
            labels: {
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              // 툴팁 커스터마이징: "식비: 350,000원 (45.5%)"
              label: function(context) {
                let label = context.label || '';
                let value = context.raw;
                let percent = percentages[context.dataIndex];

                if (label) {
                  label += ': ';
                }
                label += new Intl.NumberFormat('ko-KR').format(value) + '원';
                label += ' (' + percent + '%)';
                return label;
              }
            }
          }
        }
      }
    });
  }
</script>

</body>
</html>