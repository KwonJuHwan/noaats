<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/fragments :: head('월간 지출 통계', ~{::style})}">
  <style>
    .chart-container { position: relative; height: 400px; width: 100%; display: flex; justify-content: center; }
    .stat-card { transition: 0.3s; }
    .stat-card:hover { background-color: #f8f9fa; }
  </style>
</head>
<body class="bg-light">

<nav th:replace="~{layout/fragments :: navbar}"></nav>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a th:href="@{/statistics(yearMonth=${view.prevMonth})}" class="btn btn-outline-secondary">&lt; 이전달</a>
    <h3 class="fw-bold" th:text="${view.currentMonth} + ' 지출 통계'">2026-02 지출 통계</h3>
    <a th:href="@{/statistics(yearMonth=${view.nextMonth})}" class="btn btn-outline-secondary">다음달 &gt;</a>
  </div>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title text-center mb-4">카테고리별 비중</h5>
          <div class="chart-container" th:if="${view.hasData}">
            <canvas id="expenseChart"></canvas>
          </div>
          <div th:if="${!view.hasData}" class="text-center mt-5 text-muted">
            <p class="mb-0">해당 월의 지출 내역이 없습니다.</p>
            <small>지출을 기록하면 통계가 생성됩니다.</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title mb-3">상세 내역</h5>
          <div class="list-group list-group-flush" th:if="${view.hasData}">
            <div th:each="stat : ${view.stats}" class="list-group-item stat-card d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-bold" th:text="${stat.categoryName}">식비</span>
                <small class="text-muted ms-2" th:text="'(' + ${stat.percentage} + '%)'"> (45.5%)</small>
              </div>
              <span class="text-primary fw-bold" th:text="${#numbers.formatInteger(stat.totalAmount, 0, 'COMMA')} + '원'">350,000원</span>
            </div>
          </div>
          <div th:if="${!view.hasData}" class="text-center py-5 text-muted">데이터 없음</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{layout/fragments :: errorModal}"></div>
<th:block th:replace="~{layout/fragments :: scripts}"></th:block>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
  const statsData = [[${view.stats}]];

  if (statsData && statsData.length > 0) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const labels = statsData.map(s => s.categoryName);
    const data = statsData.map(s => s.totalAmount);
    const percentages = statsData.map(s => s.percentage);

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#8AC926', '#1982C4'],
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 20 } },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.raw;
                let percent = percentages[context.dataIndex];
                if (label) label += ': ';
                label += new Intl.NumberFormat('ko-KR').format(value) + '원 (' + percent + '%)';
                return label;
              }
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>