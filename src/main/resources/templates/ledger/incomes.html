<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ìˆ˜ì…(ì˜ˆì‚°) ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
<div class="container mt-5">
  <a href="/" class="btn btn-link">&larr; ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  <h2 class="mb-4">ğŸ’° ìˆ˜ì…(ì˜ˆì‚°) ê´€ë¦¬</h2>

  <div class="card mb-4 border-success">
    <div class="card-body">
      <h5 id="incomeFormTitle">ìƒˆ ìˆ˜ì… ë“±ë¡</h5>
      <form id="incomeForm" class="row g-3">
        <div class="col-md-3">
          <select name="incomeType" id="incomeType" class="form-select" required>
            <option value="">-- ìœ í˜• --</option>
            <option th:each="type : ${incomeTypes}"
                    th:value="${type}"
                    th:text="${type.description}"></option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="number" name="amount" id="amount" class="form-control" placeholder="ê¸ˆì•¡" required>
        </div>
        <div class="col-md-3">
          <input type="date" name="date" id="date" class="form-control" required>
        </div>
        <div class="col-md-3 d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isRegular" id="isRegular">
            <label class="form-check-label" for="isRegular">ì •ê¸° ìˆ˜ì…</label>
          </div>
          <button type="button" class="btn btn-sm btn-link ms-auto" onclick="resetIncomeForm()" id="incomeCancelBtn" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-success w-100" id="incomeSubmitBtn" onclick="saveIncome()">ë“±ë¡</button>
        </div>
      </form>
    </div>
  </div>

  <div class="alert alert-info shadow-sm mb-4" th:if="${not #lists.isEmpty(incomes)}">
    <h6 class="fw-bold"><i class="bi bi-arrow-repeat"></i> ğŸ”„ ë§¤ë‹¬ ìë™ìœ¼ë¡œ í•©ì‚°ë˜ëŠ” ì •ê¸° ìˆ˜ì…</h6>
    <hr class="my-2">
    <div class="d-flex flex-wrap gap-3">
      <div th:each="income : ${incomes}" th:if="${income.isRegular}" class="bg-white px-3 py-1 rounded-pill border border-info">
        <small class="text-muted" th:text="${income.incomeType}"></small>
        <strong class="text-primary" th:text="': ' + ${#numbers.formatInteger(income.amount, 0, 'COMMA')} + 'ì›'"></strong>
      </div>
    </div>
    <small class="text-muted mt-2 d-block">* ì •ê¸° ìˆ˜ì…ì€ ë‚ ì§œì™€ ìƒê´€ì—†ì´ ë§¤ì›” ì˜ˆì‚°ì— ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</small>
  </div>

  <table class="table table-hover bg-white shadow-sm">
    <thead class="table-success">
    <tr>
      <th>ë‚ ì§œ</th>
      <th>ìœ í˜•</th>
      <th>ê¸ˆì•¡</th>
      <th>ì •ê¸°ì—¬ë¶€</th>
      <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="income : ${incomes}">
      <td th:text="${income.date}">2024-02-11</td>
      <td th:text="${income.incomeType}">ì›”ê¸‰</td>
      <td th:text="${#numbers.formatInteger(income.amount, 0, 'COMMA')} + 'ì›'">2,000,000</td>
      <td>
        <span th:if="${income.isRegular}" class="badge bg-info">ì •ê¸°</span>
        <span th:unless="${income.isRegular}" class="badge bg-secondary">ë¹„ì •ê¸°</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-warning"
                th:data-id="${income.id}"
                th:data-type="${income.incomeTypeKey}"
                th:data-amount="${income.amount}"
                th:data-date="${income.date}"
                th:data-regular="${income.isRegular}"
                onclick="fillIncomeForm(this)">ìˆ˜ì •</button>

        <button type="button" class="btn btn-sm btn-danger"
                th:onclick="|deleteIncome(${income.id})|">ì‚­ì œ</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<script>
  // [AJAX ì €ì¥ í•¨ìˆ˜]
  async function saveIncome() {
    if(!validateIncome()) return;

    // ìˆ˜ì • ì‹œ dataset.idë¥¼ ì‚¬ìš©
    const id = document.getElementById('incomeForm').dataset.id;
    const incomeType = document.getElementById('incomeType').value;
    const amount = document.getElementById('amount').value;
    const date = document.getElementById('date').value;
    const isRegular = document.getElementById('isRegular').checked;

    const data = {
      incomeType: incomeType,
      amount: Number(amount),
      date: date,
      isRegular: isRegular
    };

    try {
      let url = '/api/incomes';
      let method = 'POST';

      if(id) {
        url += '/' + id;
        method = 'PUT';
      }

      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if(res.ok) {
        alert(id ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      } else {
        alert("ì €ì¥ ì‹¤íŒ¨");
      }
    } catch(e) { console.error(e); }
  }

  // [AJAX ì‚­ì œ í•¨ìˆ˜]
  async function deleteIncome(id) {
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      const res = await fetch(`/api/incomes/${id}`, { method: 'DELETE' });
      if(res.ok) location.reload();
      else alert("ì‚­ì œ ì‹¤íŒ¨");
    } catch(e) { console.error(e); }
  }

  // [ìˆ˜ì • í¼ ì±„ìš°ê¸°]
  function fillIncomeForm(btn) {
    const id = btn.dataset.id;
    const type = btn.dataset.type;
    const amount = btn.dataset.amount;
    const date = btn.dataset.date;
    const isRegular = btn.dataset.regular === 'true';

    document.getElementById('incomeFormTitle').innerText = "ìˆ˜ì… ë‚´ì—­ ìˆ˜ì •";
    document.getElementById('incomeType').value = type;
    document.getElementById('amount').value = amount;
    document.getElementById('date').value = date;
    document.getElementById('isRegular').checked = isRegular;

    document.getElementById('incomeSubmitBtn').innerText = "ìˆ˜ì • ì™„ë£Œ";
    document.getElementById('incomeSubmitBtn').className = "btn btn-warning w-100";
    document.getElementById('incomeCancelBtn').style.display = "block";

    // IDë¥¼ í¼ì˜ datasetì— ì €ì¥ (AJAXìš©)
    document.getElementById('incomeForm').dataset.id = id;
  }

  // [ì´ˆê¸°í™”]
  function resetIncomeForm() {
    document.getElementById('incomeFormTitle').innerText = "ìƒˆ ìˆ˜ì… ë“±ë¡";
    document.getElementById('incomeForm').reset();

    document.getElementById('incomeSubmitBtn').innerText = "ë“±ë¡";
    document.getElementById('incomeSubmitBtn').className = "btn btn-success w-100";
    document.getElementById('incomeCancelBtn').style.display = "none";

    // ID ë°ì´í„° ì‚­ì œ
    delete document.getElementById('incomeForm').dataset.id;
  }

  function validateIncome() {
    const amount = Number(document.getElementById('amount').value);
    if (amount <= 0) {
      alert("ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return false;
    }
    return true;
  }
</script>
</body>
</html>