<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/fragments :: head('ìˆ˜ì…(ì˜ˆì‚°) ê´€ë¦¬', ~{})}"></head>
<body class="bg-light">

<div class="container mt-5">
  <a href="/" class="btn btn-link">&larr; ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  <h2 class="mb-4">ğŸ’° ìˆ˜ì…(ì˜ˆì‚°) ê´€ë¦¬</h2>

  <div class="card mb-4 border-success">
    <div class="card-body">
      <h5 id="incomeFormTitle">ìƒˆ ìˆ˜ì… ë“±ë¡</h5>
      <form id="incomeForm" class="row g-3">
        <div class="col-md-3">
          <select name="incomeType" id="incomeType" class="form-select" required>
            <option value="">-- ìœ í˜• --</option>
            <option th:each="type : ${incomeTypes}" th:value="${type}" th:text="${type.description}"></option>
          </select>
        </div>
        <div class="col-md-3"><input type="number" name="amount" id="amount" class="form-control" placeholder="ê¸ˆì•¡" required></div>
        <div class="col-md-3"><input type="date" name="date" id="date" class="form-control" required></div>
        <div class="col-md-3 d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="isRegular" id="isRegular">
            <label class="form-check-label" for="isRegular">ì •ê¸° ìˆ˜ì…</label>
          </div>
          <button type="button" class="btn btn-sm btn-link ms-auto" onclick="resetIncomeForm()" id="incomeCancelBtn" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div class="col-12"><button type="button" class="btn btn-success w-100" id="incomeSubmitBtn" onclick="saveIncome()">ë“±ë¡</button></div>
      </form>
    </div>
  </div>

  <div class="alert alert-info shadow-sm mb-4" th:if="${not #lists.isEmpty(incomes)}">
    <h6 class="fw-bold"><i class="bi bi-arrow-repeat"></i> ğŸ”„ ë§¤ë‹¬ ìë™ìœ¼ë¡œ í•©ì‚°ë˜ëŠ” ì •ê¸° ìˆ˜ì…</h6>
    <hr class="my-2">
    <div class="d-flex flex-wrap gap-3">
      <div th:each="income : ${incomes}" th:if="${income.isRegular}" class="bg-white px-3 py-1 rounded-pill border border-info">
        <small class="text-muted" th:text="${income.incomeType}"></small>
        <strong class="text-primary" th:text="': ' + ${#numbers.formatInteger(income.amount, 0, 'COMMA')} + 'ì›'"></strong>
      </div>
    </div>
    <small class="text-muted mt-2 d-block">* ì •ê¸° ìˆ˜ì…ì€ ë‚ ì§œì™€ ìƒê´€ì—†ì´ ë§¤ì›” ì˜ˆì‚°ì— ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</small>
  </div>

  <table class="table table-hover bg-white shadow-sm">
    <thead class="table-success">
    <tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ì •ê¸°ì—¬ë¶€</th><th>ê´€ë¦¬</th></tr>
    </thead>
    <tbody>
    <tr th:each="income : ${incomes}">
      <td th:text="${income.date}"></td>
      <td th:text="${income.incomeType}"></td>
      <td th:text="${#numbers.formatInteger(income.amount, 0, 'COMMA')} + 'ì›'"></td>
      <td>
        <span th:if="${income.isRegular}" class="badge bg-info">ì •ê¸°</span>
        <span th:unless="${income.isRegular}" class="badge bg-secondary">ë¹„ì •ê¸°</span>
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-warning" th:data-id="${income.id}" th:data-type="${income.incomeTypeKey}" th:data-amount="${income.amount}" th:data-date="${income.date}" th:data-regular="${income.isRegular}" onclick="fillIncomeForm(this)">ìˆ˜ì •</button>
        <button type="button" class="btn btn-sm btn-danger" th:onclick="|deleteIncome(${income.id})|">ì‚­ì œ</button>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<div th:replace="~{layout/fragments :: errorModal}"></div>
<th:block th:replace="~{layout/fragments :: scripts}"></th:block>

<script>
  async function saveIncome() {
    if(!validateIncome()) return;
    const id = document.getElementById('incomeForm').dataset.id;
    const data = {
      incomeType: document.getElementById('incomeType').value,
      amount: Number(document.getElementById('amount').value),
      date: document.getElementById('date').value,
      isRegular: document.getElementById('isRegular').checked
    };

    try {
      let url = '/api/incomes';
      let method = 'POST';
      if(id) { url += '/' + id; method = 'PUT'; }

      await callApi(url, method, data);
      alert(id ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } catch(e) { console.log(e); }
  }

  async function deleteIncome(id) {
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      await callApi(`/api/incomes/${id}`, 'DELETE');
      location.reload();
    } catch(e) { console.log(e); }
  }

  function fillIncomeForm(btn) {
    document.getElementById('incomeFormTitle').innerText = "ìˆ˜ì… ë‚´ì—­ ìˆ˜ì •";
    document.getElementById('incomeType').value = btn.dataset.type;
    document.getElementById('amount').value = btn.dataset.amount;
    document.getElementById('date').value = btn.dataset.date;
    document.getElementById('isRegular').checked = btn.dataset.regular === 'true';
    document.getElementById('incomeSubmitBtn').innerText = "ìˆ˜ì • ì™„ë£Œ";
    document.getElementById('incomeSubmitBtn').className = "btn btn-warning w-100";
    document.getElementById('incomeCancelBtn').style.display = "block";
    document.getElementById('incomeForm').dataset.id = btn.dataset.id;
  }

  function resetIncomeForm() {
    document.getElementById('incomeFormTitle').innerText = "ìƒˆ ìˆ˜ì… ë“±ë¡";
    document.getElementById('incomeForm').reset();
    document.getElementById('incomeSubmitBtn').innerText = "ë“±ë¡";
    document.getElementById('incomeSubmitBtn').className = "btn btn-success w-100";
    document.getElementById('incomeCancelBtn').style.display = "none";
    delete document.getElementById('incomeForm').dataset.id;
  }

  function validateIncome() {
    if (Number(document.getElementById('amount').value) <= 0) { alert("ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return false; }
    return true;
  }
</script>
</body>
</html>